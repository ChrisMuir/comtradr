---
title: "Intro to comtradr"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Intro to comtradr}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, echo = FALSE}
knitr::opts_chunk$set(comment = "#>", collapse = TRUE, fig.width = 9, fig.height = 6)
```

## Package information

API wrapper for the [UN Comtrade Database](https://comtrade.un.org/data/), which features inter-country trade data dating back to the early 1990's. Full API documentation can be found [here](https://comtrade.un.org/data/doc/api/). This package allows users to interact with the API directly from R, and features functions for making queries and importing data.

## Install and load comtradr

Install from CRAN:
```{r eval = FALSE}
install.packages("comtradr")
```
Or install the development version from GitHub:
```{r eval = FALSE}
devtools::install_github("ChrisMuir/comtradr")
```
Load comtradr
```{r}
library(comtradr)
```

## Making API calls
Lets say we want to get data on all imports into the United States from Germany, France, Japan, and Mexico, for all years.
```{r}
q <- ct_search(reporters = "USA", 
               partners = c("Germany", "France", "Japan", "Mexico"), 
               trade_direction = "imports")

# API calls will always return a list of length three.
q$msg
q$details
str(q$data)
```

Here are a few more examples to show the different parameter options:

Limit the search range to shipments between 2010 and 2014.
```{r, eval = FALSE}
q <- ct_search(reporters = "USA", 
               partners = c("Germany", "France", "Japan", "Mexico"), 
               trade_direction = "imports", 
               start_date = "2010-01-01", 
               end_date = "2014-01-01")
```

By default, the return data is in yearly amounts. We can specify monthly, however the API limits each "monthly" query to a five month span.
```{r, eval = FALSE}
q <- ct_search(reporters = "USA", 
               partners = c("Germany", "France", "Japan", "Mexico"), 
               trade_direction = "imports", 
               start_date = "2012-03-01", 
               end_date = "2012-07-01", 
               freq = "monthly")
```

Countries passed to parameters `reporters` and `partners` must be spelled as they appear in the country code lookup table. Function `ct_country_lookup` allows us to query the country code look up table.
```{r}
ct_country_lookup("korea", "reporter")
ct_country_lookup("bolivia", "partner")
```
```{r, eval = FALSE}
q <- ct_search(reporters = "Rep. of Korea", 
               partners = "Bolivia (Plurinational State of)", 
               trade_direction = "all")
```

Search trade related to specific commodities (say, tomatoes). We can query the commodity database to see all of the different commodity descriptions available for tomatoes.
```{r}
ct_commodity_lookup("tomato")
```
If we want to search for shipment data on all of the commodity descriptions listed, then we can simply adjust the params for `ct_commodity_lookup` so that it will return only the codes, which can then be passed along to `ct_search`.
```{r, eval = FALSE}
tomato_codes <- ct_commodity_lookup("tomato", 
                                    return_code = TRUE, 
                                    return_char = TRUE)

q <- ct_search(reporters = "USA", 
               partners = c("Germany", "France", "Japan", "Mexico"), 
               trade_direction = "all", 
               commod_codes = tomato_codes)
```
On the other hand, if we wanted to exclude the juice and sauces from our search, we can pass a vector of the relevant codes to the API call.
```{r}
q <- ct_search(reporters = "USA", 
               partners = c("Germany", "France", "Japan", "Mexico"), 
               trade_direction = "all", 
               commod_codes = c("0702", "070200", "2002", "200210", "200290"))
```

## API search metadata

In addition to the trade data, each API return object contains metadata as attributes.
```{r}
# The url of the API call.
attributes(q)$url
# The date-time of the API call.
attributes(q)$time_stamp

# The total duration of the API call, in seconds.
attributes(q)$req_duration
```

## More on the lookup functions

Functions `ct_country_lookup` and `ct_commodity_lookup` are both able to take multiple search terms as input.
```{r}
ct_country_lookup(c("Belgium", "vietnam", "brazil"), "reporter")

ct_commodity_lookup(c("tomato", "trout"), return_char = TRUE)
```

`ct_commodity_lookup` can return a vector (as seen above) or a named list, using parameter `return_char`
```{r}
ct_commodity_lookup(c("tomato", "trout"), return_char = FALSE)
```

For `ct_commodity_lookup`, if any of the input search terms return zero results, and parameter `verbose` is set to `TRUE`, a warning will be printed to console (set `verbose` to `FALSE` to turn off this feature).
```{r}
ct_commodity_lookup(c("tomato", "sldfkjkfdsklsd"), verbose = TRUE)
```

## API rate limits

The Comtrade API imposes rate limits on both guest users and premium users. `comtradr` features automated throttling of API calls to ensure the user stays within the limits defined by Comtrade. Below is a breakdown of those limits, API docs on these details can be found [here](https://comtrade.un.org/data/doc/api/#Authentication).

* Without authentication token: 1 request per second, 100 requests per hour.
* With valid user token: 1 request per second, 10,000 requests per hour.

In addition to these rate limits, the API imposes some limits on parameter combinations.

* Between args `reporters`, `partners`, and the query date range, only one of these three may use the catch-all input "All".
* For the same group of three (`reporters`, `partners`, date range), if the input is not "All", then the maximum number of input values for each is five (for date range, if not using "All", then the `start_date` and `end_date` must at most span five months or five years).
* For arg `commod_codes`, if not using input "All", then the maximum number of input values is 20 (although "All" is always a valid input).

Additionally, the maximum number of returned records from a single query without a token is 50,000. With a token, that number is 250,000.

`comtradr` features a few functions for working with the API rate limits and tokens.

* `ct_register_token("some_valid_token_str")` allows a user to set an API token as a global variable. 
* `ct_get_remaining_hourly_queries()` will return the number of remaining queries for the current hour.
* `ct_get_reset_time()` will return the date/time in which the hourly time limit will reset, as a `POSIXct` object.


## Visualize

Once the data is collected, we can use it to create some basic visualizations.

**Plot 1**: Plot total value (USD) of Chinese exports to Mexico, South Korea and the United States, by year.

```{r, warning = FALSE, message = FALSE}
library(ggplot2)

# Comtrade api query.
df <- ct_search(reporters = "China", 
                partners = c("Rep. of Korea", "USA", "Mexico"), 
                trade_direction = "exports")
df <- df$data

# Create plot.
ggplot(df, aes(year, `trade_value_usd`, color = factor(partner), 
               shape = factor(partner))) +
  geom_point(size = 2) +
  geom_line(size = 1) +
  scale_x_continuous(limits = c(min(df$year), max(df$year)), 
                     breaks = seq.int(min(df$year), max(df$year), 2)) +
  scale_color_manual(values = c("orange", "blue", "red"), 
                     name = "Destination\nCountry") +
  scale_shape_discrete(name = "Destination\nCountry") +
  labs(title = "Total Value (USD) of Chinese Exports, by Year",
       x = "year", y = "total value of shipments in USD") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))
```

**Plot 2**: Plot the top eight destination countries/areas of Thai shrimp exports, by weight (KG), for 2007 - 2011.

```{r, warning = FALSE, message = FALSE}
library(ggplot2)
library(dplyr)

# First, collect commodity codes related to shrimp..
shrimp_codes <- ct_commodity_lookup("shrimp", 
                                    return_code = TRUE, 
                                    return_char = TRUE)

# Comtrade api query.
df <- ct_search(reporters = "Thailand", 
                partners = "All", 
                trade_direction = "exports", 
                start_date = "2007-01-01", 
                end_date = "2011-01-01", 
                commod_codes = shrimp_codes)

# Create country specific "total weight per year" dataframe for plotting.
plotdf <- df$data %>% 
  group_by_(.dots = c("partner", "year")) %>% 
  summarise(kg = as.numeric(sum(netweight_kg, na.rm = TRUE))) %>% 
  as_data_frame()

# Get vector of the top 8 destination countries/areas by total weight shipped 
# across all years, then subset plotdf to only include observations related 
# to those countries/areas.
top8 <- plotdf %>% 
  group_by(partner) %>% 
  summarise(kg = as.numeric(sum(kg, na.rm = TRUE))) %>% 
  arrange(desc(kg)) %>% 
  magrittr::extract2("partner") %>% 
  magrittr::extract(1:8)
plotdf <- plotdf %>% filter(partner %in% top8)

# Create plots (y-axis is NOT fixed across panels, this will allow us to ID 
# trends over time within each country/area individually).
qplot(year, kg, data = plotdf) + 
  geom_line(data = plotdf[plotdf$partner %in% names(which(table(plotdf$partner) > 1)), ]) + 
  xlim(min(plotdf$year), max(plotdf$year)) + 
  labs(title = "Weight (KG) of Thai Shrimp Exports, by Destination Area, 2007 - 2011", 
       x = "year", y = "sum of weight of all shipments in KG") + 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1), 
        axis.text = element_text(size = 7)) + 
  facet_wrap(~factor(partner, levels = top8), scales = "free", nrow = 2, ncol = 4)
```
